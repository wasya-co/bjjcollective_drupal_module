<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\field\Entity\FieldStorageConfig;
use Drupal\field\Entity\FieldConfig;
use Drupal\node\Entity\Node;
use Drupal\node\NodeInterface;
use Symfony\Component\HttpFoundation\RedirectResponse;

use Drupal\ish_drupal_module\Models\YoutubeChannel;

/*
 * for piousbox_com as a magazine
 * adds field_last_polled_at to youtube_channel
**/
function ish_drupal_module_update_9001() {
  $content_type = 'youtube_channel';
  $field_name = 'field_last_polled_at';

  if (!FieldStorageConfig::loadByName('node', $field_name)) {
    FieldStorageConfig::create([
      'field_name' => $field_name,
      'entity_type' => 'node',
      'type' => 'string',
      'settings' => [
        'max_length' => 255,
      ],
      'cardinality' => 1,
      'translatable' => TRUE,
    ])->save();
  }
  if (!FieldConfig::loadByName('node', $content_type, $field_name)) {
    FieldConfig::create([
      'field_name' => $field_name,
      'entity_type' => 'node',
      'bundle' => $content_type,
      'label' => $field_name,
      'description' => $field_name,
      'required' => FALSE,
      'settings' => [],
    ])->save();
  }
}

/**
 * Migrate article values from field_tag_contrib to field_tags_contrib.
**/
function ish_drupal_module_update_9002() {
  $nids = \Drupal::entityQuery('node')
    ->condition('type', 'article')
    ->execute();

  $nodes = Node::loadMultiple($nids);

  foreach ($nodes as $node) {
    if ($node->hasField('field_tag_contrib') && $node->hasField('field_tags_contrib')) {
      $old_values = $node->get('field_tag_contrib')->getValue();
      $node->set('field_tags_contrib', $old_values);
      $node->set('field_tag_contrib', []);
      $node->save();
    }
  }

  \Drupal::messenger()->addMessage('Migrated field_tag_contrib values to field_tags_contrib.');
}

/*
 * create users for all youtube channels
**/
function ish_drupal_module_update_9003() {
  $nids = \Drupal::entityQuery('node')
    ->condition('type', 'youtube_channel')
    ->execute();

  foreach ($nids as $nid) {
    $ch = new YoutubeChannel($nid);
    $ch->afterCreate();
  }
  \Drupal::messenger()->addMessage('created users for all youtube channels');
}


